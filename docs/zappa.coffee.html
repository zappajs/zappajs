<!DOCTYPE html>

<html>
<head>
  <title>Zappa</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="io-session.coffee.html">
                  io-session.coffee.md
                </a>
              
                
                <a class="source" href="route.coffee.html">
                  route.coffee.md
                </a>
              
                
                <a class="source" href="seemify.coffee.html">
                  seemify.coffee.md
                </a>
              
                
                <a class="source" href="settings.coffee.html">
                  settings.coffee.md
                </a>
              
                
                <a class="source" href="zappa.coffee.html">
                  zappa.coffee.md
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="zappa">Zappa</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><strong>Zappa</strong> is a <a href="http://coffeescript.org">CoffeeScript</a> DSL-ish interface for building web apps on the <a href="http://nodejs.org">node.js</a> runtime, integrating <a href="http://expressjs.com">express</a>, <a href="http://socket.io">socket.io</a> and other best-of-breed libraries.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>pkg = <span class="hljs-built_in">require</span> <span class="hljs-string">'../package'</span>
zappa = version: pkg.version

debug = (<span class="hljs-built_in">require</span> <span class="hljs-string">'debug'</span>) pkg.name
fs = <span class="hljs-built_in">require</span> <span class="hljs-string">'fs'</span>
path = <span class="hljs-built_in">require</span> <span class="hljs-string">'path'</span>
util = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>
uuid = <span class="hljs-built_in">require</span> <span class="hljs-string">'node-uuid'</span>
methods = <span class="hljs-built_in">require</span> <span class="hljs-string">'methods'</span>
invariate = <span class="hljs-built_in">require</span> <span class="hljs-string">'invariate'</span>

session = <span class="hljs-built_in">require</span> <span class="hljs-string">'express-session'</span>
io_session = <span class="hljs-built_in">require</span> <span class="hljs-string">'./io-session'</span>
zappa_settings = <span class="hljs-built_in">require</span> <span class="hljs-string">'./settings'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Soft dependencies:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>uglify = <span class="hljs-literal">null</span>
coffee_css = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>CoffeeScript-generated JavaScript may contain anyone of these; when we “rewrite” a function (see below) though, it loses access to its parent scope, and consequently to any helpers it might need. So we need to reintroduce these helpers manually inside any “rewritten” function.
This list is taken from coffeescript’s <code>src/nodes.coffee</code> UTILITIES.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>coffeescript_helpers = <span class="hljs-built_in">require</span> <span class="hljs-string">'coffeescript-helpers'</span>
<span class="hljs-function">
<span class="hljs-title">minify</span> = <span class="hljs-params">(js)</span> -&gt;</span>
  uglify ?= <span class="hljs-built_in">require</span> <span class="hljs-string">'uglify-js'</span>
  result = uglify.minify js, fromString:<span class="hljs-literal">true</span>
  result.code</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Flatten array recursively (copied from Express’s utils.js)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">flatten</span> = <span class="hljs-params">(arr, ret)</span> -&gt;</span>
  ret ?= []
  <span class="hljs-keyword">for</span> o <span class="hljs-keyword">in</span> arr
    <span class="hljs-keyword">if</span> Array.isArray o
      flatten o, ret
    <span class="hljs-keyword">else</span>
      ret.push o
  ret</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Address-hash</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">connection_hash</span> = <span class="hljs-params">({remoteAddress},len)</span> -&gt;</span>
  sum = <span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..remoteAddress.len]
    sum += remoteAddress.charCodeAt <span class="hljs-number">1</span>
  i % len</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h1 id="zappa-application">Zappa Application</h1>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Takes in a function and builds express/socket.io apps based on the rules contained in it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>zappa.app = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> arguments
    <span class="hljs-keyword">switch</span> <span class="hljs-keyword">typeof</span> a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'function'</span>
        func = a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'object'</span>
        options = a

  options ?= {}

  express = options.express ? <span class="hljs-built_in">require</span> <span class="hljs-string">'express'</span>

  seem = options.seem ? <span class="hljs-built_in">require</span> <span class="hljs-string">'seem'</span>

  seemify = (<span class="hljs-built_in">require</span> <span class="hljs-string">'./seemify'</span>) seem

  context = {id: uuid.v4(), zappa, express, session}

  root = path.dirname <span class="hljs-built_in">module</span>.parent.filename</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Storage for user-provided stuff:</p>
<ul>
<li>Handlers (callbacks) for Socket.IO;</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ws_handlers = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <ul>
<li>Helper functions.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  helpers = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>The application itself is ExpressJS’.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app = context.app = express()</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Use the <code>https</code> options to create a HTTP web server, create a plain HTTP server otherwise.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  http_module = <span class="hljs-keyword">switch</span>
    <span class="hljs-keyword">when</span> options.http_module?
      options.http_module
    <span class="hljs-keyword">when</span> options.https?
      <span class="hljs-built_in">require</span> <span class="hljs-string">'https'</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-built_in">require</span> <span class="hljs-string">'http'</span>

  context.server = <span class="hljs-keyword">switch</span>
    <span class="hljs-keyword">when</span> options.server?
      options.server
    <span class="hljs-keyword">when</span> options.https?
      http_module.createServer options.https, app
    <span class="hljs-keyword">else</span>
      http_module.createServer app</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Set <code>options.io</code> to <code>false</code> to disable socket.io.
Set <code>options.io</code> to socket.io’s parameters otherwise (optional).
Default is to enable Socket.IO with its default options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  io = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">if</span> options.io <span class="hljs-keyword">isnt</span> <span class="hljs-literal">false</span>
    socketio = options.socketio ? <span class="hljs-built_in">require</span> <span class="hljs-string">'socket.io'</span>
    io = context.io = options.io_handler ? socketio context.server, options.io ? {}</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h1 id="zappaview">ZappaView</h1>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  views = context.views = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Zappa View is used to inject views declared inside the Zappa context into Express (without writing them to the filesystem, etc.).</p>
<p>This is our own version of Express’ original <code>lib/view.js</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZappaView</span></span>
    constructor: <span class="hljs-function"><span class="hljs-params">(name,options = {})</span> -&gt;</span>
      @root = options.root ? <span class="hljs-string">''</span>
      engines = options.engines
      defaultEngine = options.defaultEngine
      @ext = path.extname name
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @ext <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> defaultEngine
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">'No default engine was specified and no extensions was provided.'</span>
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @ext
        @ext = <span class="hljs-keyword">if</span> defaultEngine[<span class="hljs-number">0</span>] <span class="hljs-keyword">isnt</span> <span class="hljs-string">'.'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">".<span class="hljs-subst">#{defaultEngine}</span>"</span> <span class="hljs-keyword">else</span> defaultEngine
        name += @ext
      [@path,@proto] = @lookup name
      <span class="hljs-keyword">if</span> @proto?
        <span class="hljs-keyword">if</span> @proto
          @engine = engines[<span class="hljs-string">"<span class="hljs-subst">#{@ext}</span> zappa"</span>] ?= <span class="hljs-built_in">require</span>(@ext.slice <span class="hljs-number">1</span>).render
        <span class="hljs-keyword">else</span>
          @engine = engines[@ext] ?= <span class="hljs-built_in">require</span>(@ext.slice <span class="hljs-number">1</span>).__express
      @path</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h2 id="lookup">Lookup</h2>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>First look inside our internal set of views, then use the filesystem.
Return <code>path,proto</code> where <code>proto</code> indicates whether the document is internal or filesystem.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    lookup: <span class="hljs-function"><span class="hljs-params">(p)</span> -&gt;</span>
<span class="hljs-function">      <span class="hljs-title">exists</span> = <span class="hljs-params">(p)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> views[p]?
          <span class="hljs-keyword">return</span> [p,<span class="hljs-literal">true</span>]
        <span class="hljs-keyword">if</span> fs.existsSync p
          <span class="hljs-keyword">return</span> [p,<span class="hljs-literal">false</span>]
        <span class="hljs-literal">null</span>

      exists( path.resolve @root, p ) ? exists( path.join path.dirname(p), path.basename(p,@ext), <span class="hljs-string">"index.<span class="hljs-subst">#{@ext}</span>"</span> ) ? [<span class="hljs-literal">null</span>,<span class="hljs-literal">null</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h2 id="render">Render</h2>

            </div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Try to render the internal view or the filesystem view based on the <code>proto</code> flag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    render: <span class="hljs-function"><span class="hljs-params">(options,fn)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> @proto
        e = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">try</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>FIXME: pass parameters as per Express2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          r = @engine views[@path], options, @path
        <span class="hljs-keyword">catch</span> error
          e = <span class="hljs-string">"Engine .render for <span class="hljs-subst">#{@ext}</span> failed: <span class="hljs-subst">#{error}</span>"</span>
        fn e, r
      <span class="hljs-keyword">else</span>
        @engine @path, options, fn</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h1 id="zappa-s-default-settings">Zappa’s default settings</h1>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  app.set <span class="hljs-string">'view'</span>, ZappaView
  app.set <span class="hljs-string">'view engine'</span>, <span class="hljs-string">'coffee'</span>

  teacup = <span class="hljs-built_in">require</span> <span class="hljs-string">'teacup'</span>
  teacup_express = <span class="hljs-built_in">require</span> <span class="hljs-string">'teacup/lib/express'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Render <code>.coffee</code> files using Teacup.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.engine <span class="hljs-string">'coffee'</span>, teacup_express.renderFile</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Render our internal views using Teacup as well.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.engine <span class="hljs-string">'coffee zappa'</span>, <span class="hljs-function"><span class="hljs-params">(template,options)</span> -&gt;</span> (teacup.renderable template).call options, options</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Provide <code>@teacup</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  context.teacup = teacup

  app.set <span class="hljs-string">'views'</span>, path.join(root, <span class="hljs-string">'/views'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Location of zappa-specific URIs.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.set <span class="hljs-string">'zappa_prefix'</span>, <span class="hljs-string">'/zappa'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <h1 id="-apply_helpers-"><code>apply_helpers</code></h1>

            </div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">apply_helpers</span> = <span class="hljs-params">(ctx)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> name, helper <span class="hljs-keyword">of</span> helpers
      <span class="hljs-keyword">do</span> (name, helper) -&gt;
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> helper <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
          ctx[name] = <span class="hljs-function">-&gt;</span>
            seemify helper, ctx, arguments
        <span class="hljs-keyword">else</span>
          ctx[name] = helper
        <span class="hljs-keyword">return</span>
    ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h1 id="route">route</h1>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Register a route with express.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  route = (<span class="hljs-built_in">require</span> <span class="hljs-string">'./route'</span>) {context,apply_helpers,seemify}</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h1 id="middleware-handling">Middleware handling</h1>

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Turn a function such as <code>route</code> or <code>receive</code> into a middleware-supporting function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">middlewarify</span> = <span class="hljs-params">(handler,verb = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    (args...) -&gt;
      arity = args.length</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Multiple arguments: path, middleware…, handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> arity &gt; <span class="hljs-number">1</span>
        handler
          verb: verb
          path: args[<span class="hljs-number">0</span>]
          middleware: flatten args[<span class="hljs-number">1.</span>..arity<span class="hljs-number">-1</span>]
          handler: args[arity<span class="hljs-number">-1</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Single argument: multiple routes in an object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> args[<span class="hljs-number">0</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>For each individual entry, if the value is an array, its content must be <code>middleware..., handler</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> v <span class="hljs-keyword">instanceof</span> Array
            handler
              verb: verb
              path: k
              middleware: flatten v[<span class="hljs-number">0.</span>..v.length<span class="hljs-number">-1</span>]
              handler: v[v.length<span class="hljs-number">-1</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Otherwise, the value is simply the handler.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">else</span>
            handler
              verb: verb
              path: k
              handler: v
        <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <h1 id="verbs-aka-http-methods-">Verbs (aka HTTP methods)</h1>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> verb <span class="hljs-keyword">in</span> [methods...,<span class="hljs-string">'all'</span>]
    <span class="hljs-keyword">do</span> (verb) -&gt;
      context[verb] = middlewarify route, verb</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <h1 id="-route">.route</h1>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  context.route = <span class="hljs-function"><span class="hljs-params">(p)</span> -&gt;</span>
    app.route p</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <h1 id="-coffee">.coffee</h1>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  context.coffee = invariate (k,v) -&gt;
    js = coffeescript_helpers.p_exec v
    js = minify(js) <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'minify'</span>]
    route verb: <span class="hljs-string">'get'</span>, path: k, handler: js, type: <span class="hljs-string">'js'</span>
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <h1 id="-js">.js</h1>

            </div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  context.js = invariate (k,v) -&gt;
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> v <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
      js = <span class="hljs-string">"(<span class="hljs-subst">#{String(v)}</span>).call(this);"</span>
    <span class="hljs-keyword">else</span>
      js = String(v)
    js = minify(js) <span class="hljs-keyword">if</span> app.settings[<span class="hljs-string">'minify'</span>]
    route verb: <span class="hljs-string">'get'</span>, path: k, handler: js, type: <span class="hljs-string">'js'</span>
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h1 id="-css">.css</h1>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  context.css = invariate (k,v) -&gt;
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> v <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
      coffee_css ?= <span class="hljs-built_in">require</span> <span class="hljs-string">'coffee-css'</span>
      css = coffee_css.compile v
    <span class="hljs-keyword">else</span>
      css = String(v)
    route verb: <span class="hljs-string">'get'</span>, path: k, handler: css, type: <span class="hljs-string">'css'</span>
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <h1 id="-helper">.helper</h1>

            </div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  context.helper = invariate (k,v) -&gt;
    helpers[k] = v
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <h1 id="-on">.on</h1>

            </div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>A ws_handler has signature <code>(ctx) -&gt;</code> (they are only used internally).
A middleware has signature <code>(ctx,res,next) -&gt;</code> (to be compatible with existing middleware).
A final handler has signature <code>(data,ack) -&gt;</code> (to be compatible with existing socket handlers).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">receive</span> = <span class="hljs-params">(r)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>The final handler is wrapped.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">    <span class="hljs-title">handler</span> = <span class="hljs-params">(ctx)</span> -&gt;</span>
      seemify r.handler, ctx, [ctx.data, ctx.ack]</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Message-specific and global middlewares are applied.</p>
<p>Translate a <code>middleware</code> and a <code>ws_handler</code> into a single <code>ws_handler</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">    <span class="hljs-title">functor</span> = <span class="hljs-params">(m,next)</span> -&gt;</span>
      (ctx) -&gt;
        m ctx, ctx.res, <span class="hljs-function"><span class="hljs-params">(error)</span> -&gt;</span>
          <span class="hljs-keyword">if</span> error?
            <span class="hljs-keyword">throw</span> error
          <span class="hljs-keyword">else</span>
            next ctx

    <span class="hljs-keyword">if</span> r.middleware?
      <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> r.middleware.reverse()
        handler = functor m, handler
    <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> ws_use.reverse()
      handler = functor m, handler</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>The socket handler is created.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (ws_handlers[r.path] ?= []).push handler

  context.<span class="hljs-literal">on</span> = middlewarify receive

  ws_use = []

  context.io_use = <span class="hljs-function">-&gt;</span>
    zappa_middleware =
      session: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
        context.session_store = options.store
<span class="hljs-function">
    <span class="hljs-title">use</span> = <span class="hljs-params">(name, arg = <span class="hljs-literal">null</span>)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> zappa_middleware[name]
        ws_use.push zappa_middleware[name](arg)
      <span class="hljs-keyword">else</span>
        ws_use.push (<span class="hljs-built_in">require</span> name)(arg)

    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> arguments
      <span class="hljs-keyword">switch</span> <span class="hljs-keyword">typeof</span> a
        <span class="hljs-keyword">when</span> <span class="hljs-string">'function'</span>
          ws_use.push a
        <span class="hljs-keyword">when</span> <span class="hljs-string">'string'</span>
          use a
        <span class="hljs-keyword">when</span> <span class="hljs-string">'object'</span>
          use k, v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> a
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <h1 id="-view">.view</h1>

            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Define an internal view. Since the lookup will use a full pathname, make sure an extension is provided.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  context.view = invariate (k,v) -&gt;
    ext = path.extname k
    p = path.join app.get(<span class="hljs-string">'views'</span>), k
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ext
      p += <span class="hljs-string">'.'</span> + app.get(<span class="hljs-string">'view engine'</span>)
    views[p] = v
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <h1 id="-engine">.engine</h1>

            </div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  context.engine = invariate (k,v) -&gt;
    app.engine k, v
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <h1 id="-set">.set</h1>

            </div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  context.set = invariate (k,v) -&gt;
    app.set k, v
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <h1 id="-enable">.enable</h1>

            </div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  context.enable = <span class="hljs-function">-&gt;</span>
    app.enable i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> arguments
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <h1 id="-disable">.disable</h1>

            </div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  context.disable = <span class="hljs-function">-&gt;</span>
    app.disable i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> arguments
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <h1 id="-wrap">.wrap</h1>

            </div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Wrap Zappa-oriented middlewares so that they can be ran as regular Express middleware.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  context.wrap = <span class="hljs-function"><span class="hljs-params">(f)</span> -&gt;</span>
    (req,res,next) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>This is the context available to Zappa middleware.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      ctx =
        app: app
        io: io
        settings: app.settings
        locals: res.locals
        session: req.session</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <h1 id="express-only">Express-only</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>        request: req
        req: req
        query: req.query
        params: req.params
        body: req.body
        response: res
        res: res
        next: next

        send: <span class="hljs-function">-&gt;</span> res.send.apply res, arguments
        json: <span class="hljs-function">-&gt;</span> res.json.apply res, arguments
        jsonp: <span class="hljs-function">-&gt;</span> res.jsonp.apply res, arguments
        redirect: <span class="hljs-function">-&gt;</span> res.redirect.apply res, arguments
        format: <span class="hljs-function">-&gt;</span> res.format.apply res, arguments</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <h1 id="io-only">IO-only</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>        socket: req.socket
        client: req.client
        data: req.data
        ack: req.ack

        join: <span class="hljs-function">-&gt;</span> req.join.apply req, arguments
        leave: <span class="hljs-function">-&gt;</span> req.leave.apply req, arguments
        emit: <span class="hljs-function">-&gt;</span> req.emit.apply req, arguments
        broadcast: <span class="hljs-function">-&gt;</span> req.broadcast.apply req, arguments
        broadcast_to: <span class="hljs-function">-&gt;</span> req.broadcast_to.apply req, arguments

      apply_helpers ctx
      seemify f, ctx, [req, res, next]</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <h1 id="-use">.use</h1>

            </div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  context.use = <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Zappa middleware available as <code>@use &#39;zappa&#39;</code>, <code>@use session:options</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    zappa_middleware =
      static: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> options <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
          options = path: options
        options ?= {}
        p = options.path ? path.join(root, <span class="hljs-string">'/public'</span>)
        <span class="hljs-keyword">delete</span> options.path
        express.static(p,options)
      session: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
        context.session_store = options.store
        session options
<span class="hljs-function">
    <span class="hljs-title">use</span> = <span class="hljs-params">(name, arg = <span class="hljs-literal">null</span>)</span> -&gt;</span>
      <span class="hljs-keyword">if</span> zappa_middleware[name]
        app.use zappa_middleware[name](arg)
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> express[name] <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span>
        app.use express[name](arg)
      <span class="hljs-keyword">else</span>
        app.use (<span class="hljs-built_in">require</span> name)(arg)

    <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> arguments
      <span class="hljs-keyword">switch</span> <span class="hljs-keyword">typeof</span> a
        <span class="hljs-keyword">when</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">then</span> app.use a
        <span class="hljs-keyword">when</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">then</span> use a
        <span class="hljs-keyword">when</span> <span class="hljs-string">'object'</span>
          <span class="hljs-keyword">if</span> a.stack? <span class="hljs-keyword">or</span> a.route? <span class="hljs-keyword">or</span> a.handle?
            app.use a
          <span class="hljs-keyword">else</span>
            use k, v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> a
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <h1 id="-settings">.settings</h1>

            </div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  context.settings = app.settings</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <h1 id="-locals">.locals</h1>

            </div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  context.locals = app.locals</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <h1 id="-include">.include</h1>

            </div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  context.include = <span class="hljs-function"><span class="hljs-params">(p,args...)</span> -&gt;</span>
    sub = <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> p <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">then</span> <span class="hljs-built_in">require</span> path.join(root, p) <span class="hljs-keyword">else</span> p
    sub.include.apply context, args</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <h1 id="-param">.param</h1>

            </div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">build_param</span> = <span class="hljs-params">(callback)</span> -&gt;</span>
    (req,res,next,p) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Context available to <code>param</code> functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      ctx =
        app: app
        io: io
        settings: app.settings
        locals: res.locals
        request: req
        req: req
        query: req.query
        params: req.params
        body: req.body
        session: req.session
        response: res
        res: res
        next: next
        param: p
      apply_helpers ctx
      callback.call ctx, req, res, next, p

  context.param = invariate (k,v) -&gt;
    app.param k, build_param v
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <h1 id="socket-io">Socket.IO</h1>

            </div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Zappa local channel (the default channel used for @emit inside Zappa’s own @get etc.).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  app.set <span class="hljs-string">'zappa_channel'</span>, <span class="hljs-string">'__local'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Register socket.io handlers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  io?.sockets.<span class="hljs-literal">on</span> <span class="hljs-string">'connection'</span>, <span class="hljs-function"><span class="hljs-params">(socket,ack)</span> -&gt;</span>
    c = {}
<span class="hljs-function">
    <span class="hljs-title">build_ctx</span> = <span class="hljs-params">(o)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>Context available inside the Socket.IO <code>on</code> functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      ctx =
        app: app
        io: io
        settings: app.settings
        socket: socket
        id: socket.id
        client: c
        join: <span class="hljs-function"><span class="hljs-params">(room)</span> -&gt;</span>
          socket.join room
        leave: <span class="hljs-function"><span class="hljs-params">(room)</span> -&gt;</span>
          socket.leave room
        emit: invariate.acked (k,v,ack) -&gt;
          socket.emit.call socket, k, v, <span class="hljs-function"><span class="hljs-params">(ack_data)</span> -&gt;</span>
            ctx = build_ctx
              event: k
              data: ack_data
            seemify ack, ctx, arguments
          <span class="hljs-keyword">return</span>
        broadcast: invariate (k,v) -&gt;
          broadcast = socket.broadcast
          broadcast.emit.call broadcast, k, v
          <span class="hljs-keyword">return</span>
        broadcast_to: <span class="hljs-function"><span class="hljs-params">(room, args...)</span> -&gt;</span>
          room = io.to room
          broadcast = invariate (k,v) -&gt;
            room.emit.call room, k, v
          broadcast args...
          <span class="hljs-keyword">return</span>

      apply_helpers ctx
      <span class="hljs-keyword">if</span> o?
        ctx[k] = v <span class="hljs-keyword">for</span> own k,v <span class="hljs-keyword">of</span> o
      ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Wrap event handlers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">    <span class="hljs-title">wrap_handler</span> = <span class="hljs-params">(event,handler)</span> -&gt;</span>
      (data,ack) -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Provide req.body just like a body parser middleware would.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        req =
          body: data</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Provide res.locals just like Express does.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        res =
          locals: {}</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Provide a socket-handler context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ctx = build_ctx
          event: event
          data: data
          body: data
          ack: ack
          res: res
          response: res
          req: req
          request: req
          locals: res.locals

        handler ctx, res

    <span class="hljs-keyword">for</span> event, handlers <span class="hljs-keyword">of</span> ws_handlers <span class="hljs-keyword">when</span> event <span class="hljs-keyword">isnt</span> <span class="hljs-string">'connection'</span>
      <span class="hljs-keyword">do</span> (event,handlers) -&gt;
        <span class="hljs-keyword">for</span> handler <span class="hljs-keyword">in</span> handlers
          socket.<span class="hljs-literal">on</span> event, wrap_handler event, handler

    debug <span class="hljs-string">'Socket.IO ready'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>Trigger any handler for the <code>connection</code> event that the app might have installed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    handlers = ws_handlers.connection

    <span class="hljs-keyword">if</span> handlers?
      <span class="hljs-keyword">for</span> handler <span class="hljs-keyword">in</span> handlers
        (wrap_handler <span class="hljs-string">'connection'</span>, handler) <span class="hljs-literal">null</span>, ack
    <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <h1 id="-with">.with</h1>

            </div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Applies a plugin to the current context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  context.with = invariate (k,v) -&gt;
    ctx = {context,route,root,minify,<span class="hljs-built_in">require</span>}
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> k <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
      k = <span class="hljs-built_in">require</span> <span class="hljs-string">"zappajs-plugin-<span class="hljs-subst">#{k}</span>"</span>
    k.call ctx, v</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <h1 id="go-">Go!</h1>

            </div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  zappa_settings {context}
  io_session.bind_middleware {context}

  func.apply context</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <h1 id="express-side-api-to-bind-with-socket-io">Express-side API to bind with Socket.IO</h1>

            </div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>These need to be <em>after</em> the call to the main function to benefit from the session-store.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  io_session.bind_express {context}
  io_session.bind_io {context}

  context</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <h1 id="-zappa-run-host-port-options-root_function-"><code>zappa.run [host,] [port,] [{options},] root_function</code></h1>

            </div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Takes a function and runs it as a zappa app. Optionally accepts a port number, and/or a hostname (any order). The hostname must be a string, and the port number must be castable as a number.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>zappa.run = <span class="hljs-function">-&gt;</span>
  host = process.env.ZAPPA_HOST ? <span class="hljs-literal">null</span>
  port = process.env.ZAPPA_PORT ? <span class="hljs-number">3000</span>
  ipc_path = process.env.ZAPPA_PATH ? <span class="hljs-literal">null</span>
  root_function = <span class="hljs-literal">null</span>
  options = {}

  <span class="hljs-keyword">for</span> a <span class="hljs-keyword">in</span> arguments
    <span class="hljs-keyword">switch</span> <span class="hljs-keyword">typeof</span> a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'string'</span>
        <span class="hljs-keyword">if</span> isNaN( (Number) a ) <span class="hljs-keyword">then</span> host = a
        <span class="hljs-keyword">else</span> port = (Number) a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'number'</span> <span class="hljs-keyword">then</span> port = a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">then</span> root_function = a
      <span class="hljs-keyword">when</span> <span class="hljs-string">'object'</span>
        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> a
          <span class="hljs-keyword">switch</span> k
            <span class="hljs-keyword">when</span> <span class="hljs-string">'host'</span> <span class="hljs-keyword">then</span> host = v
            <span class="hljs-keyword">when</span> <span class="hljs-string">'port'</span> <span class="hljs-keyword">then</span> port = v
            <span class="hljs-keyword">when</span> <span class="hljs-string">'path'</span> <span class="hljs-keyword">then</span> ipc_path = v
            <span class="hljs-keyword">else</span> options[k] = v</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <h2 id="listen-for-connections">Listen for connections</h2>

            </div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">  <span class="hljs-title">listen</span> = <span class="hljs-params">(zapp)</span> -&gt;</span>

    {server} = zapp

    server.once <span class="hljs-string">'listening'</span>, <span class="hljs-function">-&gt;</span>
      addr = server.address()
      channel = <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> addr <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">then</span> addr <span class="hljs-keyword">else</span> addr.address + <span class="hljs-string">':'</span> + addr.port
      debug <span class="hljs-string">"""
        Express server listening on <span class="hljs-subst">#{channel}</span>,
        Zappa <span class="hljs-subst">#{zappa.version}</span> orchestrating the show.

      """</span>

      <span class="hljs-keyword">if</span> options.ready?
        options.ready zapp

      <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">switch</span>
      <span class="hljs-keyword">when</span> ipc_path
        server.listen ipc_path
      <span class="hljs-keyword">when</span> host
        server.listen port, host
      <span class="hljs-keyword">else</span>
        server.listen port</pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <h2 id="cluster-mode">Cluster mode</h2>

            </div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>Inspired by <a href="https://github.com/elad/node-cluster-socket.io">https://github.com/elad/node-cluster-socket.io</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> options.server <span class="hljs-keyword">is</span> <span class="hljs-string">'cluster'</span>

    throng = <span class="hljs-built_in">require</span> <span class="hljs-string">'throng'</span>
    cluster = <span class="hljs-built_in">require</span> <span class="hljs-string">'cluster'</span>
    net = <span class="hljs-built_in">require</span> <span class="hljs-string">'net'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <h2 id="cluster-master">Cluster master</h2>

            </div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">    <span class="hljs-title">master</span> = -&gt;</span>
      workers = []

      cluster.<span class="hljs-literal">on</span> <span class="hljs-string">'fork'</span>, <span class="hljs-function"><span class="hljs-params">(worker)</span> -&gt;</span>
        debug <span class="hljs-string">'Adding worker'</span>, worker.id
        workers.push worker
        <span class="hljs-literal">null</span>
      cluster.<span class="hljs-literal">on</span> <span class="hljs-string">'exit'</span>, <span class="hljs-function"><span class="hljs-params">(worker)</span> -&gt;</span>
        index = workers.indexOf worker
        debug <span class="hljs-string">'Removing worker'</span>, worker.id, index
        <span class="hljs-keyword">if</span> index &gt;= <span class="hljs-number">0</span>
          workers.splice index, <span class="hljs-number">1</span>
        <span class="hljs-literal">null</span>

      server_options = pauseOnConnect: <span class="hljs-literal">true</span>

      <span class="hljs-keyword">if</span> options.https?
        <span class="hljs-keyword">for</span> own k,v <span class="hljs-keyword">of</span> options.https
          server_options[k] ?= v

      server = net.createServer server_options, <span class="hljs-function"><span class="hljs-params">(connection)</span> -&gt;</span>
        worker = workers[ connection_hash connection, workers.length ]
        worker.send <span class="hljs-string">'sticky-session:connection'</span>, connection

      zapp = {server}
      listen zapp
<span class="hljs-function">
    <span class="hljs-title">start</span> = <span class="hljs-params">(id)</span> -&gt;</span>
      debug <span class="hljs-string">"Starting worker <span class="hljs-subst">#{id}</span>"</span>

      http_module = <span class="hljs-keyword">switch</span>
        <span class="hljs-keyword">when</span> options.http_module?
          options.http_module
        <span class="hljs-keyword">when</span> options.https?
          <span class="hljs-built_in">require</span> <span class="hljs-string">'https'</span>
        <span class="hljs-keyword">else</span>
          <span class="hljs-built_in">require</span> <span class="hljs-string">'http'</span>

      server = options.server = http_module.createServer()
      {app} = zappa.app root_function, options
      server.<span class="hljs-literal">on</span> <span class="hljs-string">'request'</span>, app
      process.<span class="hljs-literal">on</span> <span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-params">(message, connection)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> message <span class="hljs-keyword">is</span> <span class="hljs-string">'sticky-session:connection'</span>
        server.emit <span class="hljs-string">'connection'</span>, connection
        connection.resume()

    throng {master,start}
    zapp = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <h2 id="non-cluster-legacy-mode">Non-cluster (legacy) mode</h2>

            </div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">else</span>

    zapp = zappa.app root_function, options
    listen zapp</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>The value returned by <code>Zappa.run</code> (aka <code>Zappa</code>) is the global context in legacy mode, <code>null</code> in cluster mode.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  zapp

<span class="hljs-built_in">module</span>.exports = zappa.run
<span class="hljs-built_in">module</span>.exports.run = zappa.run
<span class="hljs-built_in">module</span>.exports.app = zappa.app
<span class="hljs-built_in">module</span>.exports.version = zappa.version</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
